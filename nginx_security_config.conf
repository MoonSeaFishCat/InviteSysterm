# 防止扫描器和爬虫访问的 Nginx 配置
# 禁止整个网站被搜索引擎收录

# 在你的 Nginx 配置文件中添加以下规则

server {
    listen 80;
    server_name invite.sstfreya.top;

    # 全局添加 X-Robots-Tag 响应头，禁止搜索引擎收录
    add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet, noimageindex" always;

    # 阻止常见扫描器和爬虫访问整个网站
    if ($http_user_agent ~* (bot|crawler|spider|scanner|curl|wget|python|java|go-http-client|masscan|nmap|nikto|sqlmap|acunetix|nessus|openvas|metasploit|burp|zap|w3af|dirbuster|gobuster|wfuzz|hydra|nuclei|httpx|subfinder|amass|shodan|censys|zoomeye|googlebot|bingbot|baiduspider|yandex|sogou)) {
        return 403 "Access Denied";
    }

    # 阻止空 User-Agent
    if ($http_user_agent = "") {
        return 403 "Access Denied";
    }

    # 阻止管理后台访问
    location /admin {
        # 额外的安全检查
        if ($http_user_agent ~* (bot|crawler|spider|scanner|curl|wget|python|java|go-http-client|masscan|nmap|nikto|sqlmap|acunetix|nessus|openvas|metasploit|burp|zap|w3af|dirbuster|gobuster|wfuzz|hydra|nuclei|httpx|subfinder|amass|shodan|censys|zoomeye|googlebot|bingbot|baiduspider|yandex|sogou)) {
            return 403 "Access Denied";
        }

        # 限制请求频率（每个 IP 每分钟最多 30 个请求）
        limit_req zone=admin_limit burst=5 nodelay;

        # 代理到后端
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 阻止对 /api/admin 的访问
    location /api/admin {
        # 阻止所有爬虫和扫描器
        if ($http_user_agent ~* (bot|crawler|spider|scanner|curl|wget|python|java|go-http-client|masscan|nmap|nikto|sqlmap|acunetix|nessus|openvas|metasploit|burp|zap|w3af|dirbuster|gobuster|wfuzz|hydra|nuclei|httpx|subfinder|amass|shodan|censys|zoomeye|googlebot|bingbot|baiduspider|yandex|sogou)) {
            return 403 "Access Denied";
        }

        # 限制请求频率
        limit_req zone=admin_limit burst=5 nodelay;

        # 代理到后端
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 登录接口的额外限制
    location /api/admin/login {
        # 阻止所有爬虫和扫描器
        if ($http_user_agent ~* (bot|crawler|spider|scanner|curl|wget|python|java|go-http-client|masscan|nmap|nikto|sqlmap|acunetix|nessus|openvas|metasploit|burp|zap|w3af|dirbuster|gobuster|wfuzz|hydra|nuclei|httpx|subfinder|amass|shodan|censys|zoomeye|googlebot|bingbot|baiduspider|yandex|sogou)) {
            return 403 "Access Denied";
        }

        # 更严格的速率限制
        limit_req zone=login_limit burst=2 nodelay;

        # 代理到后端
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 其他路由正常代理
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 在 http 块中添加速率限制配置
http {
    # 管理后台速率限制：每个 IP 每分钟最多 30 个请求
    limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=30r/m;

    # 登录接口速率限制：每个 IP 每 5 分钟最多 5 次尝试
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/m;

    # ... 其他配置
}

